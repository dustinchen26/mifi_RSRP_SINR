<!-- 
  Copyright © [2023] [Dustin_Chen]. All rights reserved.
  Author: Dustin_Chen
  Email:  Dustin_Chen@compal.com or chuhpsdustin@gmail.com
-->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSRP and SINR Plot</title>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.2;
      font-size: 14px;
    }

    canvas {
      width: 900px;
      height: 400px;
      max-width: 100%; /* 適應小屏幕 */
      margin: 5px auto;
      display: block;
    }

    .red {
      color: red; /* 將紅色樣式正確應用於該class */
    }
	
	
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    function parseLog() {
      var inputText = document.getElementById('logInput').value;

      // Regular expression to match date, RSRP, and SINR
      var regex = /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})[\s\S]*?NR5G: RSRQ -\d+ dB, RSRP (-?\d+) dBm, SINR (\d+) dB/g;

      var matches = inputText.matchAll(regex);
      var timeData = [], rsrpData = [], sinrData = [];

      for (const match of matches) {
        if (match && match.length === 4) {
          timeData.push(match[1]);        // Time
          rsrpData.push(parseInt(match[2]));  // RSRP
          sinrData.push(parseInt(match[3]));  // SINR
        }
      }

      // Plot the data separately for RSRP and SINR
      plotRSRPData(timeData, rsrpData);
      plotSINRData(timeData, sinrData);
    }

    function plotRSRPData(timeData, rsrpData) {
      // Check if myChartRSRP already exists and is a Chart instance
      if (window.myChartRSRP instanceof Chart) {
        window.myChartRSRP.destroy();
      }

      const ctx = document.getElementById('myChartRSRP').getContext('2d');
      window.myChartRSRP = new Chart(ctx, {
        type: 'line',
        data: {
          labels: timeData,
          datasets: [
            {
              label: 'RSRP (dBm)',
              data: rsrpData,
              borderColor: 'blue',
              borderWidth: 1, // Adjust line thickness here
              fill: false,
              pointRadius: 0  // Hide points on the line
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'category',
              title: {
                display: true,
                text: 'Time'
              }
            },
            y: {
              title: {
                display: true,
                text: 'RSRP (dBm)'
              }
            }
          }
        }
      });
    }

    function plotSINRData(timeData, sinrData) {
      // Check if myChartSINR already exists and is a Chart instance
      if (window.myChartSINR instanceof Chart) {
        window.myChartSINR.destroy();
      }

      const ctx = document.getElementById('myChartSINR').getContext('2d');
      window.myChartSINR = new Chart(ctx, {
        type: 'line',
        data: {
          labels: timeData,
          datasets: [
            {
              label: 'SINR (dB)',
              data: sinrData,
              borderColor: 'green',
              borderWidth: 1, // Adjust line thickness here
              fill: false,
              pointRadius: 0  // Hide points on the line
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'category',
              title: {
                display: true,
                text: 'Time'
              }
            },
            y: {
              title: {
                display: true,
                text: 'SINR (dB)'
              }
            }
          }
        }
      });
    }
  </script>
</head>

<body>
  <h2>RSRP and SINR Plot</h2>
  <p style="margin: 0;">Author: Dustin_Chen, email: <a href="mailto:Dustin_Chen@compal.com"
      style="line-height: 1;">Dustin_Chen@compal.com</a> or <a href="mailto:chuhpsdustin@gmail.com"
      style="line-height: 1;">chuhpsdustin@gmail.com</a></p>  
  <ul>
    <li><strong>【How to use】</strong>
      <ul>
        <li>step0. Set the UE time correctly. ex:<br>
          <span class="red">date -s "2024-08-20 09:03:50"</span>
        </li>
        <li>step1. MobaXterm Session -> SSH -> Terminal settings -> Select "Log terminal output to": _DesktopDir_</li>
        <li>step2. ssh into mifi. ex: 10.205.164.22 </li>
        <li>step3. "Mifi" use below command to run 10 times <br>
          <span class="red">watch -n 1 'echo "$(date "+%Y-%m-%d %H:%M:%S")"; atcli at+cesqdbm'</span>
        </li>
        <li>step4. paste the _DesktopDir_ output file content below to parse</li>
	  </ul>
  <textarea id="logInput" rows="10" cols="80"></textarea>
  <br>
  <button onclick="parseLog()">Parse and Plot</button>
  <h3>RSRP (dBm)</h3>
  <canvas id="myChartRSRP"></canvas>
  <h3>SINR (dB)</h3>
  <canvas id="myChartSINR"></canvas>	  
    </li>
</ul>
</body>

</html>
